<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Rhythm Tap Hero</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Rhythm Tap">
    <meta name="theme-color" content="#1a0033">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(180deg, #1a0033 0%, #330066 50%, #660099 100%);
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        #gameArea {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        #trackArea {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        .track {
            position: absolute;
            width: 20%;
            height: 100%;
            border-left: 2px solid rgba(255,255,255,0.1);
            border-right: 2px solid rgba(255,255,255,0.1);
        }
        
        .track:nth-child(1) { left: 10%; background: linear-gradient(180deg, transparent 0%, rgba(255,0,100,0.1) 100%); }
        .track:nth-child(2) { left: 30%; background: linear-gradient(180deg, transparent 0%, rgba(100,255,0,0.1) 100%); }
        .track:nth-child(3) { left: 50%; background: linear-gradient(180deg, transparent 0%, rgba(0,100,255,0.1) 100%); }
        .track:nth-child(4) { left: 70%; background: linear-gradient(180deg, transparent 0%, rgba(255,255,0,0.1) 100%); }
        
        #hitZone {
            position: absolute;
            bottom: 100px;
            left: 10%;
            right: 10%;
            height: 80px;
            display: flex;
            gap: 0;
        }
        
        .hitButton {
            flex: 1;
            border: 3px solid rgba(255,255,255,0.5);
            border-radius: 15px;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            cursor: pointer;
            transition: all 0.1s;
        }
        
        .hitButton:active, .hitButton.pressed {
            transform: scale(0.95);
            background: rgba(255,255,255,0.3);
            border-color: white;
        }
        
        .hitButton:nth-child(1) { border-color: #ff0064; }
        .hitButton:nth-child(2) { border-color: #64ff00; }
        .hitButton:nth-child(3) { border-color: #0064ff; }
        .hitButton:nth-child(4) { border-color: #ffff00; }
        
        .note {
            position: absolute;
            width: 80%;
            height: 60px;
            left: 10%;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            font-weight: bold;
            color: white;
            animation: fall linear;
        }
        
        @keyframes fall {
            from {
                transform: translateY(-100px);
            }
            to {
                transform: translateY(calc(100vh + 100px));
            }
        }
        
        .note.track-0 { background: linear-gradient(135deg, #ff0064, #ff3399); }
        .note.track-1 { background: linear-gradient(135deg, #64ff00, #99ff33); }
        .note.track-2 { background: linear-gradient(135deg, #0064ff, #3399ff); }
        .note.track-3 { background: linear-gradient(135deg, #ffff00, #ffff66); }
        
        .hitEffect {
            position: absolute;
            pointer-events: none;
            font-size: 30px;
            font-weight: bold;
            animation: hitPop 0.5s ease-out forwards;
            z-index: 100;
        }
        
        @keyframes hitPop {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -150%) scale(1.5);
                opacity: 0;
            }
        }
        
        .hitEffect.perfect {
            color: #ffd700;
            text-shadow: 0 0 20px #ffd700;
        }
        
        .hitEffect.great {
            color: #00ff00;
            text-shadow: 0 0 20px #00ff00;
        }
        
        .hitEffect.good {
            color: #ffff00;
            text-shadow: 0 0 20px #ffff00;
        }
        
        .hitEffect.miss {
            color: #ff0000;
            text-shadow: 0 0 20px #ff0000;
        }
        
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            z-index: 50;
        }
        
        .uiElement {
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 15px;
            color: white;
            font-weight: bold;
        }
        
        .score {
            font-size: 24px;
        }
        
        .combo {
            font-size: 20px;
            color: #ffd700;
        }
        
        .combo.high {
            animation: pulse 0.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        #songSelect {
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, #1a0033 0%, #330066 50%, #660099 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 30px;
            z-index: 200;
        }
        
        #songSelect h1 {
            font-size: 48px;
            color: white;
            text-shadow: 0 0 30px rgba(255,255,255,0.5);
            animation: glow 2s ease-in-out infinite;
        }
        
        @keyframes glow {
            0%, 100% { text-shadow: 0 0 30px rgba(255,255,255,0.5); }
            50% { text-shadow: 0 0 50px rgba(255,255,255,0.8); }
        }
        
        .songList {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 80%;
            max-width: 600px;
        }
        
        .songCard {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .songCard:hover {
            transform: translateX(10px);
            border-color: white;
            background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
        }
        
        .songTitle {
            font-size: 24px;
            color: white;
            margin-bottom: 5px;
        }
        
        .songDifficulty {
            color: rgba(255,255,255,0.7);
        }
        
        .stars {
            color: #ffd700;
            margin-left: 10px;
        }
        
        #pauseMenu {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 30px;
            z-index: 150;
        }
        
        #pauseMenu.show {
            display: flex;
        }
        
        .button {
            background: linear-gradient(135deg, #ff0064, #0064ff);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 24px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .button:hover {
            transform: scale(1.05);
        }
        
        .button:active {
            transform: scale(0.95);
        }
        
        #results {
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, #1a0033 0%, #330066 50%, #660099 100%);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            z-index: 200;
            color: white;
        }
        
        #results.show {
            display: flex;
        }
        
        .resultsTitle {
            font-size: 48px;
            font-weight: bold;
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .resultsStats {
            font-size: 24px;
            text-align: center;
            animation: fadeIn 0.5s ease-out 0.3s both;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .grade {
            font-size: 120px;
            font-weight: bold;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: bounce 0.5s ease-out 0.5s both;
        }
        
        @keyframes bounce {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        #pauseBtn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            z-index: 60;
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>
    <div id="gameArea">
        <div id="ui">
            <div class="uiElement">
                <div class="score">Score: <span id="score">0</span></div>
            </div>
            <div class="uiElement">
                <div class="combo"><span id="combo">0</span>x Combo</div>
            </div>
        </div>
        
        <button id="pauseBtn">⏸</button>
        
        <div id="trackArea">
            <div class="track"></div>
            <div class="track"></div>
            <div class="track"></div>
            <div class="track"></div>
        </div>
        
        <div id="hitZone">
            <div class="hitButton" data-track="0">🎵</div>
            <div class="hitButton" data-track="1">🎶</div>
            <div class="hitButton" data-track="2">🎵</div>
            <div class="hitButton" data-track="3">🎶</div>
        </div>
    </div>
    
    <div id="songSelect">
        <h1>🎸 Rhythm Tap Hero 🎸</h1>
        <div class="songList">
            <div class="songCard" data-song="easy">
                <div class="songTitle">Rainbow Dreams</div>
                <div class="songDifficulty">Difficulty: Easy <span class="stars">⭐</span></div>
            </div>
            <div class="songCard" data-song="medium">
                <div class="songTitle">Electric Nights</div>
                <div class="songDifficulty">Difficulty: Medium <span class="stars">⭐⭐</span></div>
            </div>
            <div class="songCard" data-song="hard">
                <div class="songTitle">Cosmic Thunder</div>
                <div class="songDifficulty">Difficulty: Hard <span class="stars">⭐⭐⭐</span></div>
            </div>
            <div class="songCard" data-song="extreme">
                <div class="songTitle">Digital Chaos</div>
                <div class="songDifficulty">Difficulty: Extreme <span class="stars">⭐⭐⭐⭐</span></div>
            </div>
        </div>
    </div>
    
    <div id="pauseMenu">
        <h2 style="color: white; font-size: 36px;">PAUSED</h2>
        <button class="button" onclick="resumeGame()">Resume</button>
        <button class="button" onclick="restartSong()">Restart</button>
        <button class="button" onclick="quitToMenu()">Quit</button>
    </div>
    
    <div id="results">
        <div class="resultsTitle">Song Complete!</div>
        <div class="grade" id="grade">S</div>
        <div class="resultsStats">
            <div>Score: <span id="finalScore">0</span></div>
            <div>Max Combo: <span id="maxCombo">0</span></div>
            <div>Perfect: <span id="perfectCount">0</span></div>
            <div>Great: <span id="greatCount">0</span></div>
            <div>Good: <span id="goodCount">0</span></div>
            <div>Miss: <span id="missCount">0</span></div>
        </div>
        <button class="button" onclick="backToMenu()">Back to Songs</button>
    </div>
    
    <script>
        // Game state
        let score = 0;
        let combo = 0;
        let maxCombo = 0;
        let notes = [];
        let gameRunning = false;
        let isPaused = false;
        let currentSong = null;
        let noteSpeed = 2000; // ms for note to fall
        let audioContext = null;
        let songStartTime = 0;
        let animationFrame = null;
        
        // Hit statistics
        let perfectCount = 0;
        let greatCount = 0;
        let goodCount = 0;
        let missCount = 0;
        
        // Songs data
        const songs = {
            easy: {
                name: "Rainbow Dreams",
                bpm: 120,
                duration: 60000,
                notePattern: generateEasyPattern()
            },
            medium: {
                name: "Electric Nights",
                bpm: 140,
                duration: 90000,
                notePattern: generateMediumPattern()
            },
            hard: {
                name: "Cosmic Thunder",
                bpm: 160,
                duration: 120000,
                notePattern: generateHardPattern()
            },
            extreme: {
                name: "Digital Chaos",
                bpm: 180,
                duration: 150000,
                notePattern: generateExtremePattern()
            }
        };
        
        // Initialize audio
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        
        // Play note sound
        function playNoteSound(track) {
            if (!audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Different pitch for each track
            const frequencies = [261.63, 329.63, 392.00, 523.25]; // C, E, G, C
            oscillator.frequency.value = frequencies[track];
            oscillator.type = 'square';
            
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }
        
        // Play background music
        function playBackgroundMusic() {
            if (!audioContext || !currentSong) return;
            
            const tempo = songs[currentSong].bpm;
            const interval = 60000 / tempo / 4; // 16th notes
            
            let beat = 0;
            const musicInterval = setInterval(() => {
                if (!gameRunning || isPaused) {
                    clearInterval(musicInterval);
                    return;
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Simple bass line
                if (beat % 4 === 0) {
                    oscillator.frequency.value = 55; // Low A
                    oscillator.type = 'sine';
                    gainNode.gain.value = 0.2;
                } else if (beat % 2 === 0) {
                    oscillator.frequency.value = 110; // A
                    oscillator.type = 'triangle';
                    gainNode.gain.value = 0.1;
                } else {
                    oscillator.frequency.value = 220 + Math.random() * 440; // Random melody
                    oscillator.type = 'square';
                    gainNode.gain.value = 0.05;
                }
                
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.05);
                
                beat++;
            }, interval);
        }
        
        // Generate note patterns
        function generateEasyPattern() {
            const pattern = [];
            for (let i = 0; i < 50; i++) {
                pattern.push({
                    track: Math.floor(Math.random() * 4),
                    time: i * 1000 + 2000
                });
            }
            return pattern;
        }
        
        function generateMediumPattern() {
            const pattern = [];
            for (let i = 0; i < 100; i++) {
                pattern.push({
                    track: Math.floor(Math.random() * 4),
                    time: i * 700 + 2000
                });
                if (i % 4 === 0) {
                    pattern.push({
                        track: Math.floor(Math.random() * 4),
                        time: i * 700 + 2350
                    });
                }
            }
            return pattern;
        }
        
        function generateHardPattern() {
            const pattern = [];
            for (let i = 0; i < 150; i++) {
                pattern.push({
                    track: Math.floor(Math.random() * 4),
                    time: i * 500 + 2000
                });
                if (i % 3 === 0) {
                    pattern.push({
                        track: Math.floor(Math.random() * 4),
                        time: i * 500 + 2250
                    });
                }
            }
            return pattern;
        }
        
        function generateExtremePattern() {
            const pattern = [];
            for (let i = 0; i < 200; i++) {
                pattern.push({
                    track: Math.floor(Math.random() * 4),
                    time: i * 400 + 2000
                });
                if (i % 2 === 0) {
                    pattern.push({
                        track: Math.floor(Math.random() * 4),
                        time: i * 400 + 2200
                    });
                }
            }
            return pattern;
        }
        
        // Create falling note
        function createNote(track, startTime) {
            const note = document.createElement('div');
            note.className = `note track-${track}`;
            note.dataset.track = track;
            note.dataset.startTime = startTime;
            note.textContent = '♪';
            
            const trackElement = document.querySelectorAll('.track')[track];
            trackElement.appendChild(note);
            
            // Set animation duration based on note speed
            note.style.animationDuration = `${noteSpeed}ms`;
            
            // Remove note after animation
            setTimeout(() => {
                if (note.parentNode) {
                    note.remove();
                    // Check if note was missed
                    checkMiss(note);
                }
            }, noteSpeed);
            
            return note;
        }
        
        // Check if note was missed
        function checkMiss(note) {
            if (note.parentNode) {
                missCount++;
                combo = 0;
                updateUI();
                showHitEffect(parseInt(note.dataset.track), 'MISS', 'miss');
            }
        }
        
        // Handle hit button press
        function handleHit(track) {
            const trackElement = document.querySelectorAll('.track')[track];
            const notes = trackElement.querySelectorAll('.note');
            
            let hitNote = null;
            let minDistance = Infinity;
            
            // Find closest note to hit zone
            notes.forEach(note => {
                const rect = note.getBoundingClientRect();
                const hitZoneRect = document.getElementById('hitZone').getBoundingClientRect();
                const distance = Math.abs(rect.bottom - hitZoneRect.top);
                
                if (distance < minDistance && distance < 100) {
                    minDistance = distance;
                    hitNote = note;
                }
            });
            
            if (hitNote) {
                // Calculate hit accuracy
                let hitRating;
                let points;
                
                if (minDistance < 20) {
                    hitRating = 'PERFECT';
                    points = 300;
                    perfectCount++;
                } else if (minDistance < 40) {
                    hitRating = 'GREAT';
                    points = 200;
                    greatCount++;
                } else if (minDistance < 70) {
                    hitRating = 'GOOD';
                    points = 100;
                    goodCount++;
                } else {
                    hitRating = 'MISS';
                    points = 0;
                    missCount++;
                }
                
                if (hitRating !== 'MISS') {
                    combo++;
                    score += points * (1 + combo * 0.1);
                    playNoteSound(track);
                } else {
                    combo = 0;
                }
                
                maxCombo = Math.max(maxCombo, combo);
                
                // Remove hit note
                hitNote.remove();
                
                // Show hit effect
                showHitEffect(track, hitRating, hitRating.toLowerCase());
                
                updateUI();
            }
        }
        
        // Show hit effect
        function showHitEffect(track, text, className) {
            const effect = document.createElement('div');
            effect.className = `hitEffect ${className}`;
            effect.textContent = text;
            
            const button = document.querySelectorAll('.hitButton')[track];
            const rect = button.getBoundingClientRect();
            
            effect.style.left = rect.left + rect.width / 2 + 'px';
            effect.style.top = rect.top + 'px';
            
            document.body.appendChild(effect);
            
            setTimeout(() => effect.remove(), 500);
        }
        
        // Update UI
        function updateUI() {
            document.getElementById('score').textContent = Math.floor(score);
            document.getElementById('combo').textContent = combo;
            
            const comboElement = document.querySelector('.combo');
            if (combo > 10) {
                comboElement.classList.add('high');
            } else {
                comboElement.classList.remove('high');
            }
        }
        
        // Start song
        function startSong(songId) {
            currentSong = songId;
            const song = songs[songId];
            
            // Reset stats
            score = 0;
            combo = 0;
            maxCombo = 0;
            perfectCount = 0;
            greatCount = 0;
            goodCount = 0;
            missCount = 0;
            notes = [];
            
            // Hide song select
            document.getElementById('songSelect').style.display = 'none';
            
            // Set note speed based on difficulty
            noteSpeed = 3000 - (song.bpm - 120) * 10;
            
            gameRunning = true;
            songStartTime = Date.now();
            
            // Start background music
            initAudio();
            playBackgroundMusic();
            
            // Schedule notes
            song.notePattern.forEach(noteData => {
                setTimeout(() => {
                    if (gameRunning && !isPaused) {
                        createNote(noteData.track, noteData.time);
                    }
                }, noteData.time);
            });
            
            // End song after duration
            setTimeout(() => {
                if (gameRunning) {
                    endSong();
                }
            }, song.duration);
            
            updateUI();
        }
        
        // End song
        function endSong() {
            gameRunning = false;
            
            // Calculate grade
            const totalNotes = perfectCount + greatCount + goodCount + missCount;
            const accuracy = totalNotes > 0 ? (perfectCount * 100 + greatCount * 80 + goodCount * 50) / totalNotes : 0;
            
            let grade;
            if (accuracy >= 95) grade = 'S';
            else if (accuracy >= 90) grade = 'A';
            else if (accuracy >= 80) grade = 'B';
            else if (accuracy >= 70) grade = 'C';
            else grade = 'D';
            
            // Show results
            document.getElementById('grade').textContent = grade;
            document.getElementById('finalScore').textContent = Math.floor(score);
            document.getElementById('maxCombo').textContent = maxCombo;
            document.getElementById('perfectCount').textContent = perfectCount;
            document.getElementById('greatCount').textContent = greatCount;
            document.getElementById('goodCount').textContent = goodCount;
            document.getElementById('missCount').textContent = missCount;
            
            document.getElementById('results').classList.add('show');
        }
        
        // Pause game
        function pauseGame() {
            if (!gameRunning) return;
            isPaused = true;
            document.getElementById('pauseMenu').classList.add('show');
        }
        
        // Resume game
        function resumeGame() {
            isPaused = false;
            document.getElementById('pauseMenu').classList.remove('show');
            playBackgroundMusic();
        }
        
        // Restart song
        function restartSong() {
            document.getElementById('pauseMenu').classList.remove('show');
            document.querySelectorAll('.note').forEach(n => n.remove());
            startSong(currentSong);
        }
        
        // Quit to menu
        function quitToMenu() {
            gameRunning = false;
            isPaused = false;
            document.getElementById('pauseMenu').classList.remove('show');
            document.getElementById('songSelect').style.display = 'flex';
            document.querySelectorAll('.note').forEach(n => n.remove());
        }
        
        // Back to menu from results
        function backToMenu() {
            document.getElementById('results').classList.remove('show');
            document.getElementById('songSelect').style.display = 'flex';
        }
        
        // Event listeners
        document.querySelectorAll('.songCard').forEach(card => {
            card.addEventListener('click', () => {
                startSong(card.dataset.song);
            });
        });
        
        document.querySelectorAll('.hitButton').forEach(button => {
            button.addEventListener('click', () => {
                if (gameRunning && !isPaused) {
                    handleHit(parseInt(button.dataset.track));
                    button.classList.add('pressed');
                    setTimeout(() => button.classList.remove('pressed'), 100);
                }
            });
        });
        
        // Keyboard controls
        const keyMap = { 'd': 0, 'f': 1, 'j': 2, 'k': 3 };
        document.addEventListener('keydown', (e) => {
            if (keyMap[e.key] !== undefined && gameRunning && !isPaused) {
                handleHit(keyMap[e.key]);
                document.querySelectorAll('.hitButton')[keyMap[e.key]].classList.add('pressed');
            }
        });
        
        document.addEventListener('keyup', (e) => {
            if (keyMap[e.key] !== undefined) {
                document.querySelectorAll('.hitButton')[keyMap[e.key]].classList.remove('pressed');
            }
        });
        
        document.getElementById('pauseBtn').addEventListener('click', pauseGame);
        
        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js');
            });
        }
    </script>
</body>
</html>